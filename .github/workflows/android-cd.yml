name: Android CD

on:
  push:
    branches:
      - 'release'
    tags:
      - 'android-v*'
  workflow_dispatch:
    inputs:
      release_track:
        description: 'Play store íŠ¸ëž™ ì„ íƒ'
        required: true
        default: internal
        type: choice
        options:
          - internal
          - beta
          - production

permissions:
  contents: write
  packages: write

jobs:
  release:
    # if ì¡°ê±´ : ìˆ˜ë™ ë¦´ë¦¬ì¦ˆì‹œì—ëŠ” ë¦´ë¦¬ì¦ˆ ë¸Œëžœì¹˜ì—ì„œë§Œ ë¦´ë¦¬ì¦ˆë  ìˆ˜ ìžˆë„ë¡ +
    # ê¸°ë³¸ ìžë™ ë¦´ë¦¬ì¦ˆì‹œì—ëŠ” ì»¤ë°‹ ë©”ì‹œì§€ê°€[debug] ì¸ ê²½ìš°ì—ëŠ” ë¦´ë¦¬ì¦ˆë˜ì§€ ì•Šë„ë¡ +
    # íƒœê·¸ ê¸°ë°˜ìœ¼ë¡œë„ ë¦´ë¦¬ì¦ˆ ë  ìˆ˜ ìžˆë„ë¡
    if: |
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/release')
      || (github.event_name == 'push' && github.ref == 'refs/heads/release' && !contains(github.event.head_commit.message, '[debug]'))
      || startsWith(github.ref, 'refs/tags/')
    name: Build & Deploy Release AAB
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Grant gradlew permission
        run: chmod +x ./gradlew

      - name: Gradle ë¹Œë“œ ìºì‹œ
        uses: gradle/gradle-build-action@v2

      - name: Android SDK ìºì‹œ
        uses: actions/cache@v3
        with:
          path: |
            ~/.android
            ~/.gradle
          key: android-sdk-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install SDK Components
        run: |
          yes | sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Build AAB
        run: ./gradlew bundleRelease

      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        with:
          tag_name: auto-${{ github.run_number }}
          name: Release auto-${{ github.run_number }}
          prerelease: true
          files: |
            android/app/build/outputs/apk/release/app-release-unsigned.apk
            android/app/build/outputs/bundle/release/app-release.aab
            output/release.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #------------------------------------------------------------------------
      - name: Upload APK to AWS S3
        uses: jakejarvis/s3-sync-action@master
        with:
          args: --follow-symlinks --delete
        env:
          AWS_S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.S3_BUCKET_REGION }}
          SOURCE_DIR: android/app/build/outputs/apk/release/
          DEST_DIR: release/apk/
      #------------------------------------------------------------------------
      - name: Generate Presigned URL
        id: presign
        run: |
          URL=$(aws s3 presign s3://dlals4585/release/apk/app-release.apk \
            --region ap-northeast-2 \
            --expires-in 3600)
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Show Presigned URL
        run:
          echo "ðŸ“¦ APK Download URL: ${{ steps.presign.outputs.url }}"
      #------------------------------------------------------------------------
      #Fastlaneì„ ì‚¬ìš©í•œ ì•± ë°°í¬ ì˜ˆì‹œ
      # > Fastlaneì´ Google play developer apië¥¼ ë‚´ë¶€ì ìœ¼ë¡œ wrappingí•´ì„œ ì‚¬ìš©í•¨
      # > fastlane/Fastlane íŒŒì¼ì— ê´€ë ¨ ë‚´ìš© ì •ì˜ë¨
#      - name: Set up Ruby
#        uses: ruby/setup-ruby@v1
#        with:
#          ruby-version: '3.2'
#
#      - name: Install Fastlane
#        run: gem install fastlane
#
#      - name: Deploy to Play Store
#        run: fastlane internal
#        env:
#          GOOGLE_PLAY_KEY: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
#          PACKAGE_NAME: ${{ secrets.PACKAGE_NAME }}
      #------------------------------------------------------------------------
      #upload-google-play ì‚¬ìš©í•œ ì•± ë°°í¬ ì˜ˆì‹œ
      # > GitHub Actionsìš© Play Store ì—…ë¡œë“œ ì•¡ì…˜
#      - name: Upload AAB to Google Play
#        uses: r0adkll/upload-google-play@v1
#        with:
#          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
#          packageName: ${{ secrets.PACKAGE_NAME }}
#          #releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
#          releaseFiles: '**/release/*.aab'
#          track: ${{ github.event.inputs.release_track }}
#          status: completed
      #------------------------------------------------------------------------
#      #ì‚¬ë‚´ NAS/API ì—…ë¡œë“œ(curl) ì˜ˆì‹œ
#      - name: Upload to QA NAS via API
#        if: contains(github.event.head_commit.message, '[release]')
#        run: |
#          curl -X POST https://ì‚¬ë‚´ ì—…ë¡œë“œ ì£¼ì†Œ \
#            -H "Authorization: Bearer ${{ secrets.NAS_API_TOKEN }}" \
#            -F "file=@app-${{ github.run_number }}.zip"
      #------------------------------------------------------------------------
#      #ì‚¬ë‚´ NAS/API ì—…ë¡œë“œ(scp) ì˜ˆì‹œ
#      - name: Upload ZIP to NAS via SCP
#        if: contains(github.event.head_commit.message, '[release]')
#        run: |
#          echo "${{ secrets.NAS_SSH_KEY }}" > id_rsa
#          chmod 600 id_rsa
#
#          scp -i id_rsa -o StrictHostKeyChecking=no \
#            app-${{ github.run_number }}.zip \
#            ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_TARGET_PATH }}
#
#          rm id_rsa
      #------------------------------------------------------------------------